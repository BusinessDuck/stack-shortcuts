"use strict";var _createClass=function(){function n(e,t){for(var r,n=0;n<t.length;n++)(r=t[n]).enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.getHash=getHash,exports.shortcuts=shortcuts;var _KeyCode=require("./utils/KeyCode"),_objectUtils=require("./utils/objectUtils"),_userAgent=require("./utils/userAgent");function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}var keyMapCache=void 0;function getPlatformKeyMap(){if(keyMapCache)return keyMapCache;var e={};return"Mac OS"!==(0,_userAgent.getOSVersion)()&&(e.CMD="CTRL"),keyMapCache=e}var MODIFIERS_MAP={metaKey:"CMD",ctrlKey:"CTRL",shiftKey:"SHIFT",altKey:"ALT"},CodeKey=(0,_objectUtils.reverse)(_KeyCode.KeyCode),stack=[];function getHash(e){return e.map(function(e){return _KeyCode.KeyCode[e]}).sort().join("")}function getModifiersList(t){var r=[];return["ctrlKey","metaKey","shiftKey","altKey"].forEach(function(e){t[e]&&r.push(MODIFIERS_MAP[e])}),r}function handleEvent(e){for(var t,r=getHash([].concat(_toConsumableArray(getModifiersList(e)),[CodeKey[e.keyCode]])),n=function(){},a=0;a<stack.length;++a)(t=stack[a]).hasHandler(r)&&(n=t.getHandler(r).bind(null,e,n));n()}function bind(){document.addEventListener("keydown",handleEvent)}function unbind(){document.removeEventListener("keydown",handleEvent)}function removeLayer(e){if(stack.length){var t=stack.indexOf(e);if(-1===t)return;stack.splice(t,1),stack.length||unbind()}}var ShortcutsManager=function(){function e(t){var r=this;_classCallCheck(this,e),this._shortcuts={},this.platformKeyMap=getPlatformKeyMap(),Object.keys(t).forEach(function(e){r.add(e,t[e])})}return _createClass(e,[{key:"resolveKeyMap",value:function(e){var t=this;return e.map(function(e){return t.platformKeyMap[e]||e})}},{key:"add",value:function(e,t){var r=getHash(this.resolveKeyMap(e.toUpperCase().split("+")));this._shortcuts[r]=t}},{key:"remove",value:function(e){var t=getHash(this.resolveKeyMap(e.toUpperCase().split("+")));delete this._shortcuts[t]}},{key:"getHandler",value:function(e){return this._shortcuts[e]||this._shortcuts[_KeyCode.KeyCode.ALL]}},{key:"hasHandler",value:function(e){return!!this.getHandler(e)}}]),e}();function shortcuts(e){if(!e)throw new Error("Config must be not empty");var t=new ShortcutsManager(e);return stack.push(t),1===stack.length&&bind(),{destroy:function(){return removeLayer(t)},manager:t}}